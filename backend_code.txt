===== backend/server.js =====
require("dotenv").config();
const app = require("./src/app");
const connectDB = require("./src/config/db");

connectDB();

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
===== backend/src/middleware/role.middleware.js =====
module.exports = (...roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ message: "Access denied" });
    }
    next();
  };
};
===== backend/src/middleware/auth.middleware.js =====
const jwt = require("jsonwebtoken");

module.exports = (req, res, next) => {
  const authHeader = req.headers.authorization;

  if (!authHeader || !authHeader.startsWith("Bearer ")) {
    return res.status(401).json({ message: "Unauthorized" });
  }

  const token = authHeader.split(" ")[1];

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded; 
    next();
  } catch (error) {
    res.status(401).json({ message: "Unauthorized" });
  }
};
===== backend/src/config/db.js =====
const mongoose = require("mongoose");

const connectDB = async () => {
  try {
    await mongoose.connect(process.env.MONGO_URI);
    console.log("MongoDB connected");
  } catch (err) {
    console.error("MongoDB connection error:", err.message);
    process.exit(1);
  }
};

module.exports = connectDB;
===== backend/src/models/User.js =====
const mongoose = require("mongoose");

const userSchema = new mongoose.Schema(
  {
    name: {
      type: String,
      required: true,
      minlength: 2,
      maxlength: 50
    },
    email: {
      type: String,
      required: true,
      unique: true,
      lowercase: true,
      match: [/^\S+@\S+\.\S+$/, "Invalid email format"]
    },
    passwordHash: {
      type: String,
      required: true
    },
    role: {
      type: String,
      enum: ["student", "instructor"],
      default: "student"
    }
  },
  {
    timestamps: { createdAt: true, updatedAt: false },
    versionKey: false
  }
);

module.exports = mongoose.model("User", userSchema);
===== backend/src/models/Course.js =====
const mongoose = require("mongoose");
const optionSchema = new mongoose.Schema(
  {
    text: { type: String, required: true }
  },
  { _id: true }
);

const taskSchema = new mongoose.Schema(
  {
    question: { type: String, required: true },
    options: { type: [optionSchema], required: true },
    correctOptionId: {
      type: mongoose.Schema.Types.ObjectId,
      required: true
    }
  },
  { _id: true }
);

const quizSchema = new mongoose.Schema(
  {
    title: { type: String, required: true },
    tasks: { type: [taskSchema], default: [] }
  },
  { _id: true }
);

const lessonSchema = new mongoose.Schema(
  {
    title: { type: String, required: true },
    content: String,
    videoUrl: String,
    orderNumber: Number
  },
  { _id: true }
);

const courseSchema = new mongoose.Schema(
  {
    title: {
      type: String,
      required: true
    },

    description: {
      type: String,
      required: true
    },

    instructorId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true
    },

    lessons: {
      type: [lessonSchema],
      default: []
    },

    quizzes: {
      type: [quizSchema],
      default: []
    }
  },
  {
    timestamps: { createdAt: true, updatedAt: false },
    versionKey: false
  }
);

module.exports = mongoose.model("Course", courseSchema);
===== backend/src/models/QuizAttempt.js =====
const mongoose = require("mongoose");

const quizAttemptSchema = new mongoose.Schema(
  {
    studentId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true
    },
    quizId: {
      type: mongoose.Schema.Types.ObjectId,
      required: true
    },
    score: {
      type: Number,
      required: true
    }
  },
  {
    timestamps: false,
    versionKey: false
  }
   
);

quizAttemptSchema.index({ quizId: 1, score: -1 });

module.exports = mongoose.model("QuizAttempt", quizAttemptSchema, "quizAttempts");
===== backend/src/models/Enrollment.js =====
const mongoose = require("mongoose");

const enrollmentSchema = new mongoose.Schema(
  {
    studentId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "User",
      required: true
    },
    courseId: {
      type: mongoose.Schema.Types.ObjectId,
      ref: "Course",
      required: true
    },
    progress: {
      type: Number,
      default: 0
    }
  },
  {
    timestamps: false,
    versionKey: false
  }
);

enrollmentSchema.index({ studentId: 1, courseId: 1 }, { unique: true });

module.exports = mongoose.model("Enrollment", enrollmentSchema);
===== backend/src/controllers/course.controller.js =====
const Course = require("../models/Course");
const Enrollment = require("../models/Enrollment");
const QuizAttempt = require("../models/QuizAttempt");

exports.createCourse = async (req, res) => {
  try {
    const { title, description } = req.body;

    const course = await Course.create({
      title,
      description,
      instructorId: req.user.id
    });

    res.status(201).json(course);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.getCourses = async (req, res) => {
  try {
    const courses = await Course.find()
      .select("-quizzes.tasks.correctOptionId");

    res.json(courses);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.getCourseById = async (req, res) => {
  try {
    const { id } = req.params;
    const userId = req.user.id;
    const role = req.user.role;

    const course = await Course.findById(id)
      .select("-quizzes.tasks.correctOptionId");

    if (!course) {
      return res.status(404).json({ message: "Course not found" });
    }

    if (role === "instructor") {
      if (course.instructorId.toString() !== userId) {
        return res.status(403).json({ message: "Access denied" });
      }
    }

    if (role === "student") {
      const enrolled = await Enrollment.exists({
        studentId: userId,
        courseId: id
      });

      if (!enrolled) {
        return res
          .status(403)
          .json({ message: "You are not enrolled in this course" });
      }
    }

    res.json(course);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};


exports.addLesson = async (req, res) => {
  try {
    const { id } = req.params;
    const { title, content, videoUrl, orderNumber } = req.body;

    const course = await Course.findOneAndUpdate(
      { _id: id, instructorId: req.user.id },
      { $push: { lessons: { title, content, videoUrl, orderNumber } } },
      { new: true }
    );

    if (!course) {
      return res.status(403).json({ message: "Access denied or course not found" });
    }

    res.json(course);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.addQuiz = async (req, res) => {
  try {
    const { id } = req.params;
    const { title, tasks } = req.body;

    const course = await Course.findOneAndUpdate(
      { _id: id, instructorId: req.user.id },
      {
        $push: {
          quizzes: { title, tasks }
        }
      },
      { new: true }
    );

    if (!course) {
      return res
        .status(403)
        .json({ message: "Access denied or course not found" });
    }

    res.json(course);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};


exports.updateCourse = async (req, res) => {
  try {
    const { id } = req.params;
    const { title, description } = req.body;

    const course = await Course.findById(id);
    if (!course) {
      return res.status(404).json({ message: "Course not found" });
    }

    if (
      course.instructorId.toString() !== req.user.id
    ) {
      return res.status(403).json({ message: "Access denied" });
    }

    if (title !== undefined) course.title = title;
    if (description !== undefined) course.description = description;

    await course.save();

    res.json(course);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.deleteCourse = async (req, res) => {
  try {
    const { id } = req.params;

    const course = await Course.findById(id);
    if (!course) {
      return res.status(404).json({ message: "Course not found" });
    }

    if (
      course.instructorId.toString() !== req.user.id
    ) {
      return res.status(403).json({ message: "Access denied" });
    }

    await Course.findByIdAndDelete(id);
    await Enrollment.deleteMany({ courseId: id });
    await QuizAttempt.deleteMany({
      quizId: { $in: course.quizzes.map(q => q._id) }
    });

    res.json({ message: "Course and related data deleted" });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.getMyCourses = async (req, res) => {
  try {
    const courses = await Course.find({
      instructorId: req.user.id
    });

    res.json(courses);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};
===== backend/src/controllers/quiz.controller.js =====
const QuizAttempt = require("../models/QuizAttempt");
const Course = require("../models/Course");
const Enrollment = require("../models/Enrollment");
const mongoose = require("mongoose");

exports.createAttempt = async (req, res) => {
  try {
    const { quizId, score } = req.body;
    const studentId = req.user.id;

    const course = await Course.findOne(
      { "quizzes._id": quizId },
      { quizzes: 1 }
    );

    if (!course) {
      return res.status(404).json({ message: "Quiz not found" });
    }

    const enrollment = await Enrollment.findOne({
      studentId,
      courseId: course._id
    });

    if (!enrollment) {
      return res.status(403).json({ message: "Not enrolled in this course" });
    }

    await QuizAttempt.create({
      studentId,
      quizId,
      score
    });

    const quizIds = course.quizzes.map(q => q._id);

    const result = await QuizAttempt.aggregate([
      {
        $match: {
          studentId: new mongoose.Types.ObjectId(studentId),
          quizId: { $in: quizIds }
        }
      },
      {
        $group: {
          _id: null,
          avgScore: { $avg: "$score" }
        }
      }
    ]);

    const progress = result.length
      ? Math.round(result[0].avgScore)
      : 0;

    enrollment.progress = progress;
    await enrollment.save();

    res.status(201).json({
      message: "Attempt saved, progress updated",
      progress
    });

  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};
===== backend/src/controllers/analytics.controller.js =====
const mongoose = require("mongoose");
const Enrollment = require("../models/Enrollment");
const Course = require("../models/Course");
const QuizAttempt = require("../models/QuizAttempt");
const User = require("../models/User");

exports.getCourseEngagement = async (req, res) => {
  try {
    const { courseId } = req.query;

    const instructorCourses = await Course.find(
      { instructorId: req.user.id },
      { _id: 1 }
    );

    const courseIds = instructorCourses.map(c => c._id);

    const pipeline = [
      {
        $match: {
          courseId: { $in: courseIds }
        }
      }
    ];

    if (courseId) {
      pipeline.push({
        $match: { courseId: new mongoose.Types.ObjectId(courseId) }
      });
    }

    pipeline.push(
      {
        $group: {
          _id: "$courseId",
          studentsCount: { $sum: 1 },
          avgProgress: { $avg: "$progress" },
          activeStudents: {
            $sum: {
              $cond: [{ $gte: ["$progress", 50] }, 1, 0]
            }
          }
        }
      },
      {
        $lookup: {
          from: "courses",
          localField: "_id",
          foreignField: "_id",
          as: "course"
        }
      },
      { $unwind: "$course" },
      {
        $project: {
          _id: 0,
          courseId: "$course._id",
          courseTitle: "$course.title",
          studentsCount: 1,
          avgProgress: { $round: ["$avgProgress", 1] },
          activeStudents: 1
        }
      },
      { $sort: { studentsCount: -1 } }
    );

    const analytics = await Enrollment.aggregate(pipeline);


    res.json(analytics);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.getTopStudentsByCourse = async (req, res) => {
  try {
    const { courseId } = req.params;
    
    const course = await Course.findOne({
      _id: courseId,
      instructorId: req.user.id
    });

    if (!course) {
      return res.status(404).json({ message: "Course not found or access denied" });
    }

    const pipeline = [
      {
        $lookup: {
          from: "courses",
          let: { quizId: "$quizId" },
          pipeline: [
            { $match: { _id: new mongoose.Types.ObjectId(courseId) } },
            { $unwind: "$quizzes" },
            {
              $match: {
                $expr: { $eq: ["$quizzes._id", "$$quizId"] }
              }
            }
          ],
          as: "courseQuiz"
        }
      },
      { $unwind: "$courseQuiz" },

      {
        $group: {
          _id: "$studentId",
          avgScore: { $avg: "$score" },
          attempts: { $sum: 1 }
        }
      },

      { $sort: { avgScore: -1 } },
      { $limit: 10 },

      {
        $lookup: {
          from: "users",
          localField: "_id",
          foreignField: "_id",
          as: "student"
        }
      },
      { $unwind: "$student" },

      {
        $project: {
          _id: 0,
          studentId: "$student._id",
          name: "$student.name",
          email: "$student.email",
          avgScore: { $round: ["$avgScore", 1] },
          attempts: 1
        }
      }
    ];

    const topStudents = await QuizAttempt.aggregate(pipeline);

    res.json(topStudents);
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};===== backend/src/controllers/auth.controller.js =====
const User = require("../models/User");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");

exports.register = async (req, res) => {
  const { name, email, password } = req.body;

  if (!email || !password) {
  return res.status(400).json({ message: "Missing required fields" });
  }

  try {
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({ message: "User already exists" });
    }

    const passwordHash = await bcrypt.hash(password, 10);

    const user = await User.create({
      name,
      email,
      passwordHash,
      role: "student"
    });

    res.status(201).json({ message: "User registered successfully" });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};

exports.login = async (req, res) => {
  const { email, password } = req.body;

  try {
    const user = await User.findOne({ email });
    if (!user) {
      return res.status(400).json({ message: "Invalid credentials" });
    }

    const isMatch = await bcrypt.compare(password, user.passwordHash);
    if (!isMatch) {
      return res.status(400).json({ message: "Invalid credentials" });
    }

    const token = jwt.sign(
      { id: user._id, role: user.role },
      process.env.JWT_SECRET,
      { expiresIn: "1d" }
    );

    res.json({ token });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};
===== backend/src/routes/quiz.routes.js =====
const express = require("express");
const router = express.Router();
const auth = require("../middleware/auth.middleware");
const role = require("../middleware/role.middleware");
const {
  createAttempt
} = require("../controllers/quiz.controller");

router.post("/attempts", auth, role("student"), createAttempt);

module.exports = router;
===== backend/src/routes/auth.routes.js =====
const express = require("express");
const router = express.Router();
const { register, login } = require("../controllers/auth.controller");

router.post("/register", register);
router.post("/login", login);

module.exports = router;
===== backend/src/routes/analytics.routes.js =====
const express = require("express");
const router = express.Router();
const auth = require("../middleware/auth.middleware");
const role = require("../middleware/role.middleware");

const {
  getCourseEngagement,
  getTopStudentsByCourse
} = require("../controllers/analytics.controller");

router.get(
  "/course-engagement",
  auth,
  role("instructor"),
  getCourseEngagement
);

router.get(
  "/courses/:courseId/top-students",
  auth,
  role("instructor"),
  getTopStudentsByCourse
);

module.exports = router;===== backend/src/routes/course.routes.js =====
const express = require("express");
const router = express.Router();
const auth = require("../middleware/auth.middleware");
const role = require("../middleware/role.middleware");
const {
  createCourse,
  getCourses,
  getCourseById,
  addLesson,
  addQuiz
} = require("../controllers/course.controller");
const { updateCourse, deleteCourse } = require("../controllers/course.controller");
const { getMyCourses } = require("../controllers/course.controller");

router.post("/", auth, role("instructor"), createCourse);
router.get("/", auth, getCourses);
router.get("/my", auth, role("instructor"), getMyCourses);
router.get("/:id", auth, getCourseById);
router.post("/:id/lessons", auth, role("instructor"), addLesson);
router.post("/:id/quizzes", auth, role("instructor"), addQuiz);
router.patch("/:id", auth, role("instructor"), updateCourse);
router.delete("/:id", auth, role("instructor"), deleteCourse);

module.exports = router
===== backend/src/routes/enrollment.routes.js =====
const express = require("express");
const router = express.Router();

const Enrollment = require("../models/Enrollment");
const authMiddleware = require("../middleware/auth.middleware"); 
const Course = require("../models/Course");
const role = require("../middleware/role.middleware");

router.post("/", authMiddleware, role("student"), async (req, res) => {
  try {
    const studentId = req.user.id;
    const { courseId } = req.body;

    const exists = await Enrollment.findOne({ studentId, courseId });
    if (exists) {
      return res.status(400).json({ message: "Already enrolled" });
    }

    const enrollment = await Enrollment.create({
      studentId,
      courseId
    });

    res.status(201).json(enrollment);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

router.get("/my", authMiddleware, async (req, res) => {
  try {
    const studentId = req.user.id;

    const enrollments = await Enrollment.find({ studentId })
      .populate("courseId");

    res.json(enrollments);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

router.get("/:courseId", authMiddleware, async (req, res) => {
  try {
    const enrollment = await Enrollment.findOne({
      studentId: req.user.id,
      courseId: req.params.courseId
    });

    res.json(enrollment);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

module.exports = router;===== backend/src/app.js =====
const express = require("express");
const cors = require("cors");

const authRoutes = require("./routes/auth.routes");
const courseRoutes = require("./routes/course.routes");
const enrollmentRoutes = require("./routes/enrollment.routes");
const quizRoutes = require("./routes/quiz.routes");
const analyticsRoutes = require("./routes/analytics.routes");

const path = require("path");
const app = express();

app.use(cors());
app.use(express.json());

app.use("/api/auth", authRoutes);
app.use("/api/enrollments", enrollmentRoutes);
app.use("/api/courses", courseRoutes);
app.use("/api/quizzes", quizRoutes);
app.use("/api/analytics", analyticsRoutes);

const frontendPath = path.join(__dirname, "../../frontend");
app.use(express.static(frontendPath));

app.use((req, res) => {
  res.sendFile(path.join(frontendPath, "index.html"));
});

module.exports = app;
